[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# PostgreSQL Database
[program:postgresql]
command=/usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/data -c config_file=/etc/postgresql/15/main/postgresql.conf
user=postgres
priority=10
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/postgresql.log
stderr_logfile=/var/log/supervisor/postgresql_error.log
environment=PGDATA="/var/lib/postgresql/data"
stopsignal=TERM
stopwaitsecs=30

# Redis Cache
[program:redis]
command=/usr/bin/redis-server /etc/redis/redis.conf
priority=20
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/redis.log
stderr_logfile=/var/log/supervisor/redis_error.log
user=redis

# MinIO Object Storage
[program:minio]
command=/usr/local/bin/minio server /var/lib/minio --console-address ":9001"
priority=30
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/minio.log
stderr_logfile=/var/log/supervisor/minio_error.log
environment=MINIO_ROOT_USER="minioadmin",MINIO_ROOT_PASSWORD="minioadmin123",MINIO_REGION_NAME="us-east-1"

# Wait for services before starting Rails
[program:wait-for-services]
command=/usr/local/bin/wait-for-services.sh
priority=40
autostart=true
autorestart=false
startsecs=0
exitcodes=0
stdout_logfile=/var/log/supervisor/wait.log
stderr_logfile=/var/log/supervisor/wait_error.log

# Rails Backend
[program:rails]
command=/usr/local/bin/bundle exec rails server -b 0.0.0.0 -p 3000
directory=/app/backend
priority=50
autostart=false
autorestart=true
stdout_logfile=/var/log/supervisor/rails.log
stderr_logfile=/var/log/supervisor/rails_error.log
environment=PATH="/root/.rbenv/shims:/usr/local/bundle/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
    RAILS_ENV="development",
    DATABASE_URL="postgresql://username:password@localhost:5432/flexile_development",
    REDIS_URL="redis://localhost:6379/0",
    SIDEKIQ_REDIS_URL="redis://localhost:6379/1",
    AWS_ENDPOINT_URL="http://localhost:9000",
    AWS_ACCESS_KEY_ID="minioadmin",
    AWS_SECRET_ACCESS_KEY="minioadmin123",
    AWS_REGION="us-east-1",
    S3_PRIVATE_BUCKET="flexile-development-private",
    S3_PUBLIC_BUCKET="flexile-development-public",
    RAILS_LOG_TO_STDOUT="true"
stopsignal=TERM
stopwaitsecs=10

# Sidekiq Background Jobs
[program:sidekiq]
command=/usr/local/bin/bundle exec sidekiq
directory=/app/backend
priority=60
autostart=false
autorestart=true
stdout_logfile=/var/log/supervisor/sidekiq.log
stderr_logfile=/var/log/supervisor/sidekiq_error.log
environment=PATH="/root/.rbenv/shims:/usr/local/bundle/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
    RAILS_ENV="development",
    DATABASE_URL="postgresql://username:password@localhost:5432/flexile_development",
    REDIS_URL="redis://localhost:6379/0",
    SIDEKIQ_REDIS_URL="redis://localhost:6379/1"
stopsignal=TERM
stopwaitsecs=10

# Next.js Frontend
[program:nextjs]
command=/usr/bin/npm run dev
directory=/app/frontend
priority=70
autostart=false
autorestart=true
stdout_logfile=/var/log/supervisor/nextjs.log
stderr_logfile=/var/log/supervisor/nextjs_error.log
environment=NODE_ENV="development",
    NEXT_TELEMETRY_DISABLED="1",
    PORT="3001",
    NEXT_PUBLIC_API_URL="http://localhost:3000",
    DATABASE_URL="postgresql://username:password@localhost:5432/flexile_development",
    REDIS_URL="redis://localhost:6379/0",
    AWS_ENDPOINT_URL="http://localhost:9000",
    AWS_ACCESS_KEY_ID="minioadmin",
    AWS_SECRET_ACCESS_KEY="minioadmin123",
    AWS_REGION="us-east-1",
    S3_PRIVATE_BUCKET="flexile-development-private",
    S3_PUBLIC_BUCKET="flexile-development-public",
    WATCHPACK_POLLING="true"
stopsignal=TERM
stopwaitsecs=10

# Nginx Reverse Proxy
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
priority=80
autostart=false
autorestart=true
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx_error.log
stopsignal=TERM
stopwaitsecs=10

# Group for application services
[group:services]
programs=postgresql,redis,minio
priority=10

# Group for application processes
[group:application]
programs=rails,sidekiq,nextjs,nginx
priority=50

# Event listener to start application after services are ready
[eventlistener:services_ready]
command=/usr/local/bin/services-ready-listener.sh
events=PROCESS_STATE_RUNNING
buffer_size=100
stdout_logfile=/var/log/supervisor/listener.log
stderr_logfile=/var/log/supervisor/listener_error.log